# 本地云空间双向同步服务 — 系统设计文档

## 1. 目标

构建一个独立于 OpenClaw 的本地 Linux 常驻服务，静默执行本地空间与飞书云空间双向同步。OpenClaw 不参与飞书 API 调用，仅在必要时读取服务状态。

## 2. 核心原则

- 服务独立运行，不与 OpenClaw 内部 runtime 强耦合
- 授权优先级：`user_access_token` > `tenant_access_token`
- 支持 Web 管理界面：配置、调试、状态查看
- 完整日志系统：运行日志、同步日志、错误日志
- 同步行为可审计：所有操作落库

## 3. 能力范围

- 飞书云空间（Drive）文件夹/文件列表与基础操作
- 飞书云文档（Docx）读取/创建/更新
- 飞书日历（Calendar）事件读取/创建/更新/删除
- 本地目录与云目录双向同步（首版以文档文件为主）

## 4. 组件架构

1. `web_server`：HTTP 服务 + Web 管理页 + JSON API
2. `sync_engine`：周期性扫描本地与云端差异，执行同步
3. `feishu_client`：统一封装飞书 API，处理 token 与重试
4. `db`：SQLite 持久化（配置快照、同步状态、操作日志）
5. `logger`：文件日志 + 数据库日志

## 5. 数据流

### 本地 → 云端
1. 扫描本地目录（按配置映射）
2. 计算 hash，和 `sync_items.local_hash` 比对
3. 有变更则上传/更新飞书文件
4. 更新 `sync_items.remote_hash` 与状态

### 云端 → 本地
1. 拉取飞书目录文件列表
2. 与 `sync_items.remote_hash` 比对
3. 云端变更则下载覆盖本地（或冲突分支）
4. 更新 `sync_items.local_hash` 与状态

## 6. 冲突策略

- 默认策略：`keep_both`
- 当双端都发生变更：
  - 本地保留当前文件
  - 拉取云端版本到 `*.remote_conflict.*`
  - 标记 `conflict` 并记录日志

## 7. 数据库表

- `settings`：服务配置项
- `sync_mappings`：本地路径与飞书 folder token 映射
- `sync_items`：文件级同步状态（hash、时间戳、冲突状态）
- `sync_runs`：每次同步任务记录
- `logs`：结构化日志（level、module、message、detail）

## 8. Web 管理界面

- 仪表盘：服务状态、上次同步时间、错误计数
- 配置页：token 路径、扫描周期、映射目录
- 同步页：手动触发、查看最近同步结果
- 日志页：过滤查看错误/警告/操作明细

## 9. 部署方式

- 进程：`python3 app.py`
- systemd user service 常驻
- 默认监听：`127.0.0.1:19333`

## 10. 与 OpenClaw 关系

- OpenClaw 不调用飞书 API
- OpenClaw 仅在必要时：
  - 读取 `GET /api/status`
  - 读取 `GET /api/logs`
  - （可选）触发 `POST /api/sync/run`
